<div class="page-header">
    <div class="page-header-title">
        <h1>âš™ï¸ {{t .Lang "settings_title"}}</h1>
    </div>
</div>

<!-- Settings Tabs -->
<div class="tabs-container">
    <nav class="tabs-nav">
        <a href="/settings/general" class="tab {{if eq .ActiveTab "general"}}active{{end}}">
            âš™ï¸ {{t .Lang "settings_general"}}
        </a>
        <a href="/settings/backup" class="tab {{if eq .ActiveTab "backup"}}active{{end}}">
            ğŸ’¾ {{t .Lang "settings_backup"}}
        </a>
        <a href="/settings/caddy" class="tab {{if eq .ActiveTab "caddy"}}active{{end}}">
            ğŸ”§ {{t .Lang "settings_caddy"}}
        </a>
        <a href="/settings/users" class="tab {{if eq .ActiveTab "users"}}active{{end}}">
            ğŸ‘¥ {{t .Lang "settings_users"}}
        </a>
    </nav>
    
    <div class="tab-content">
        {{if eq .ActiveTab "general"}}
        <!-- General Settings -->
        <div class="settings-section">
            <h2>ğŸŒ {{t .Lang "settings_language"}}</h2>
            <div class="form-group">
                <select id="language" name="language" onchange="changeLanguage(this.value)">
                    <option value="en" {{if eq .Lang "en"}}selected{{end}}>ğŸ‡¬ğŸ‡§ English</option>
                    <option value="cs" {{if eq .Lang "cs"}}selected{{end}}>ğŸ‡¨ğŸ‡¿ ÄŒeÅ¡tina</option>
                </select>
            </div>
        </div>
        
        <div class="settings-section">
            <h2>ğŸ¨ {{t .Lang "settings_theme"}}</h2>
            <div class="form-group">
                <select id="theme" name="theme" onchange="changeTheme(this.value)">
                    <option value="classic">Classic</option>
                    <option value="modern" disabled>Modern (coming soon)</option>
                </select>
            </div>
        </div>
        
        <div class="settings-section">
            <h2>â„¹ï¸ {{t .Lang "about"}}</h2>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">{{t .Lang "app_version"}}</span>
                    <span class="info-value">v{{.Config.Version}}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">{{t .Lang "build_date"}}</span>
                    <span class="info-value">{{.Config.BuildDate}}</span>
                </div>
            </div>
            <p class="text-muted mt-3">
                CPM - Caddy Proxy Manager<br>
                {{t .Lang "about_description"}}<br>
                Built with Go and â¤ï¸
            </p>
        </div>
        
        {{else if eq .ActiveTab "backup"}}
        <!-- Backup Settings -->
        <div class="settings-section">
            <h2>ğŸ’¾ {{t .Lang "backup_restore"}}</h2>
            <p class="text-muted">{{t .Lang "backup_description"}}</p>
            
            <div class="form-row mt-4">
                <div class="card flex-1">
                    <h3>ğŸ“¥ {{t .Lang "backup_create"}}</h3>
                    <p>{{t .Lang "backup_create_desc"}}</p>
                    <a href="/settings/backup/create" class="btn btn-primary">
                        â¬‡ï¸ {{t .Lang "backup_download"}}
                    </a>
                </div>
                
                <div class="card flex-1">
                    <h3>ğŸ“¤ {{t .Lang "backup_restore_title"}}</h3>
                    <p>{{t .Lang "backup_restore_desc"}}</p>
                    <form action="/settings/backup/restore" method="POST" enctype="multipart/form-data">
                        <input type="file" name="backup" accept=".zip" required>
                        <button type="submit" class="btn btn-warning mt-2">
                            â¬†ï¸ {{t .Lang "backup_upload"}}
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="settings-section">
            <h2>ğŸ“‹ {{t .Lang "import_export"}}</h2>
            <p class="text-muted">{{t .Lang "import_export_desc"}}</p>
            
            <div class="form-row mt-4">
                <div class="card flex-1">
                    <h3>ğŸ“¤ {{t .Lang "export_rules"}}</h3>
                    <p>{{t .Lang "export_rules_desc"}}</p>
                    <a href="/settings/export" class="btn btn-secondary">
                        â¬‡ï¸ {{t .Lang "export_json"}}
                    </a>
                </div>
                
                <div class="card flex-1">
                    <h3>ğŸ“¥ {{t .Lang "import_rules"}}</h3>
                    <p>{{t .Lang "import_rules_desc"}}</p>
                    <form action="/settings/import" method="POST" enctype="multipart/form-data">
                        <input type="file" name="import_file" accept=".json" required>
                        <label class="checkbox-label mt-2">
                            <input type="checkbox" name="skip_existing" checked>
                            {{t .Lang "skip_existing"}}
                        </label>
                        <button type="submit" class="btn btn-secondary mt-2">
                            â¬†ï¸ {{t .Lang "import_upload"}}
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        {{else if eq .ActiveTab "caddy"}}
        <!-- Caddy Settings -->
        <div class="settings-section">
            <h2>ğŸŒ {{t .Lang "fallback_rule"}}</h2>
            <p class="text-muted">{{t .Lang "fallback_description"}}</p>
            
            {{if .FallbackExists}}
            <form action="/settings/fallback" method="POST">
                <textarea name="content" rows="10" class="code-editor">{{.Fallback}}</textarea>
                <button type="submit" class="btn btn-primary mt-2">
                    ğŸ’¾ {{t .Lang "save"}}
                </button>
            </form>
            {{else}}
            <div class="alert alert-warning">
                {{t .Lang "fallback_not_found"}}
                <form action="/settings/fallback/create" method="POST" class="mt-2">
                    <button type="submit" class="btn btn-primary">
                        {{t .Lang "create"}} fallback.caddy
                    </button>
                </form>
            </div>
            {{end}}
        </div>
        
        <div class="settings-section">
            <h2>ğŸ“„ {{t .Lang "error_pages"}}</h2>
            <p class="text-muted">{{t .Lang "error_pages_description"}}</p>
            
            <div class="form-row mt-4">
                <div class="card flex-1">
                    <h3>403 Forbidden</h3>
                    <form action="/settings/error-page/403" method="POST">
                        <textarea name="content" rows="8" class="code-editor">{{.ErrorPage403}}</textarea>
                        <button type="submit" class="btn btn-secondary btn-sm mt-2">
                            ğŸ’¾ {{t .Lang "save"}} 403.html
                        </button>
                    </form>
                </div>
                
                <div class="card flex-1">
                    <h3>404 Not Found</h3>
                    <form action="/settings/error-page/404" method="POST">
                        <textarea name="content" rows="8" class="code-editor">{{.ErrorPage404}}</textarea>
                        <button type="submit" class="btn btn-secondary btn-sm mt-2">
                            ğŸ’¾ {{t .Lang "save"}} 404.html
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        {{else if eq .ActiveTab "users"}}
        <!-- Users Settings -->
        <div class="settings-section">
            <h2>ğŸ‘¥ {{t .Lang "user_management"}}</h2>
            
            <form action="/settings/auth/toggle" method="POST" class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" 
                           name="enabled"
                           value="true"
                           {{if .AuthEnabled}}checked{{end}}
                           onchange="this.form.submit()">
                    {{t .Lang "enable_auth"}}
                </label>
            </form>
            
            {{if not .AuthEnabled}}
            <div class="alert alert-info">
                {{t .Lang "auth_disabled_warning"}}
            </div>
            {{end}}
            
            {{if not .Users}}
            <div class="alert alert-warning">
                {{t .Lang "no_users_warning"}}
            </div>
            {{end}}
        </div>
        
        <!-- User List -->
        {{if .Users}}
        <div class="settings-section">
            <h3>{{t .Lang "existing_users"}}</h3>
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>{{t .Lang "username"}}</th>
                            <th>{{t .Lang "role"}}</th>
                            <th>{{t .Lang "created"}}</th>
                            <th>{{t .Lang "last_login"}}</th>
                            <th>{{t .Lang "actions"}}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{range .Users}}
                        <tr>
                            <td>
                                {{.RoleIcon}} <strong>{{.Username}}</strong>
                            </td>
                            <td>{{.RoleDisplayName}}</td>
                            <td>{{.CreatedAt.Format "2006-01-02"}}</td>
                            <td>{{if .LastLogin.IsZero}}{{t $.Lang "never"}}{{else}}{{.LastLogin.Format "2006-01-02 15:04"}}{{end}}</td>
                            <td>
                                <button class="btn btn-sm btn-secondary"
                                        onclick="showPasswordModal('{{.Username}}')">
                                    ğŸ”‘ {{t $.Lang "password"}}
                                </button>
                                <button class="btn btn-sm btn-danger"
                                        hx-delete="/settings/users/{{.Username}}"
                                        hx-confirm="{{t $.Lang "confirm_delete_user"}} {{.Username}}?">
                                    ğŸ—‘ï¸ {{t $.Lang "delete"}}
                                </button>
                            </td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
        </div>
        {{end}}
        
        <!-- Add User Form -->
        <div class="settings-section">
            <h3>â• {{t .Lang "add_user"}}</h3>
            <form action="/settings/users" method="POST" class="user-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="new-username">{{t .Lang "username"}}</label>
                        <input type="text" id="new-username" name="username" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="new-password">{{t .Lang "password"}}</label>
                        <input type="password" id="new-password" name="password" required minlength="6">
                    </div>
                    
                    <div class="form-group">
                        <label for="new-role">{{t .Lang "role"}}</label>
                        <select id="new-role" name="role">
                            {{range .Roles}}
                            <option value="{{.}}">{{.}}</option>
                            {{end}}
                        </select>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary">
                    â• {{t .Lang "create_user"}}
                </button>
            </form>
        </div>
        {{end}}
    </div>
</div>

<script>
function changeLanguage(lang) {
    document.cookie = `cpm_lang=${lang};path=/;max-age=31536000`;
    window.location.reload();
}

function changeTheme(theme) {
    document.cookie = `cpm_theme=${theme};path=/;max-age=31536000`;
    window.location.reload();
}

function showPasswordModal(username) {
    const newPassword = prompt(`Enter new password for ${username}:`);
    if (newPassword && newPassword.length >= 6) {
        fetch(`/settings/users/${username}/password`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: `password=${encodeURIComponent(newPassword)}`
        }).then(() => window.location.reload());
    }
}
</script>
