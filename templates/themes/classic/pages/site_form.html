<div class="page-header">
    <h1>{{if .IsNew}}â• {{t .Lang "sites_new"}}{{else}}âœï¸ {{t .Lang "edit"}}: {{.Site.PrimaryDomain}}{{end}}</h1>
    <a href="/sites" class="btn btn-secondary">â† {{t .Lang "back"}}</a>
</div>

<!-- Main Form -->
<form action="{{if .IsNew}}/sites{{else}}/sites/{{.Site.Filename}}{{end}}" 
      method="POST"
      class="site-form">
    
    {{if not .IsNew}}
    <input type="hidden" name="_method" value="PUT">
    {{end}}
    
    <div class="form-section">
        <div class="form-section-title">ğŸŒ {{t .Lang "domain_config"}}</div>
        
        <div class="form-group">
            <label for="domains">{{t .Lang "sites_domain"}} *</label>
            <input type="text" 
                   id="domains" 
                   name="domains" 
                   value="{{.Site.DomainsString}}"
                   placeholder="example.com, www.example.com"
                   required>
            <div class="form-hint">{{t .Lang "domains_hint"}}</div>
        </div>
    </div>
    
    <div class="form-section">
        <div class="form-section-title">ğŸ¯ {{t .Lang "backend_target"}}</div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="target_ip">{{t .Lang "sites_ip"}} *</label>
                <input type="text" 
                       id="target_ip" 
                       name="target_ip" 
                       value="{{if .Site.TargetIP}}{{.Site.TargetIP}}{{else}}{{.DefaultIP}}{{end}}"
                       placeholder="192.168.1.100"
                       required>
            </div>
            
            <div class="form-group">
                <label for="target_port">{{t .Lang "sites_port"}} *</label>
                <input type="text" 
                       id="target_port" 
                       name="target_port" 
                       value="{{.Site.TargetPort}}"
                       placeholder="8080"
                       required>
            </div>
        </div>
        
        <div class="form-group">
            <label class="checkbox-label">
                <input type="checkbox" 
                       name="is_https_backend" 
                       {{if .Site.IsHTTPSBackend}}checked{{end}}>
                <span>ğŸ”’ {{t .Lang "sites_https_backend"}}</span>
            </label>
        </div>
    </div>
    
    <div class="form-section">
        <div class="form-section-title">ğŸ” {{t .Lang "tls_certificate"}}</div>
        
        <div class="form-group">
            <label for="tls_mode">{{t .Lang "tls_mode"}}</label>
            <select id="tls_mode" name="tls_mode" class="form-control">
                {{if .WildcardDomains}}
                {{range .WildcardDomains}}
                <option value="wildcard:{{.Domain}}" {{if eq $.Site.TLSMode (printf "wildcard:%s" .Domain)}}selected{{end}}>
                    ğŸŒŸ {{t $.Lang "tls_use_wildcard"}} *.{{.Domain}}
                </option>
                {{end}}
                {{end}}
                <option value="auto" {{if or (eq .Site.TLSMode "auto") (eq .Site.TLSMode "")}}selected{{end}}>
                    ğŸ”„ {{t .Lang "tls_auto"}}
                </option>
            </select>
            <div class="form-hint">{{t .Lang "tls_hint"}}</div>
        </div>
    </div>
    
    <div class="form-section">
        <div class="form-section-title">âš™ï¸ {{t .Lang "sites_snippets"}}</div>
        
        <div class="snippet-options">
            {{range .AvailableSnippets}}
            <label class="snippet-option">
                <input type="checkbox" 
                       name="snippets" 
                       value="{{.}}"
                       {{if contains $.Site.Snippets .}}checked{{end}}>
                <span>
                    {{if eq . "cloudflare_dns"}}â˜ï¸{{end}}
                    {{if eq . "internal_only"}}ğŸ”’{{end}}
                    {{if eq . "security_headers"}}ğŸ›¡ï¸{{end}}
                    {{if eq . "compression"}}ğŸ“¦{{end}}
                    {{if eq . "rate_limit"}}â±ï¸{{end}}
                    {{if eq . "basic_auth"}}ğŸ”{{end}}
                    {{.}}
                </span>
            </label>
            {{end}}
        </div>
    </div>
    
    <div class="form-section">
        <div class="form-section-title">ğŸ·ï¸ {{t .Lang "sites_tags"}}</div>
        
        <div class="form-group">
            <input type="text" 
                   id="tags" 
                   name="tags" 
                   value="{{join .Site.Tags ", "}}"
                   placeholder="production, web, api">
            <div class="form-hint">{{t .Lang "tags_hint"}}</div>
        </div>
    </div>
    
    <details>
        <summary>âš¡ {{t .Lang "advanced_options"}}</summary>
        <div class="details-content">
            <div class="form-row">
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" 
                               name="enable_websocket" 
                               {{if .Site.EnableWebSocket}}checked{{end}}>
                        <span>ğŸ”Œ {{t .Lang "sites_websocket"}}</span>
                    </label>
                </div>
                
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" 
                               name="is_internal" 
                               {{if .Site.IsInternal}}checked{{end}}>
                        <span>ğŸ  {{t .Lang "sites_internal"}}</span>
                    </label>
                </div>
            </div>
            
            <div class="form-group">
                <label for="health_check_path">{{t .Lang "sites_health_check"}}</label>
                <input type="text" 
                       id="health_check_path" 
                       name="health_check_path" 
                       value="{{.Site.HealthCheckPath}}"
                       placeholder="/health">
            </div>
            
            <div class="form-group">
                <label for="extra_config">{{t .Lang "sites_extra_config"}}</label>
                <textarea id="extra_config" 
                          name="extra_config" 
                          rows="4"
                          class="code-editor"
                          placeholder="{{t .Lang "extra_config_placeholder"}}">{{.Site.ExtraConfig}}</textarea>
            </div>
        </div>
    </details>
    
    <div class="form-actions" style="display: flex; gap: 1rem; margin-top: 2rem;">
        <a href="/sites" class="btn btn-secondary">{{t .Lang "cancel"}}</a>
        <button type="submit" class="btn btn-primary">
            {{if .IsNew}}{{t .Lang "sites_create"}}{{else}}{{t .Lang "save"}}{{end}}
        </button>
    </div>
</form>

<script>
// Auto-detect matching wildcard for domain
document.addEventListener('DOMContentLoaded', function() {
    const domainsInput = document.getElementById('domains');
    const tlsSelect = document.getElementById('tls_mode');
    
    if (!domainsInput || !tlsSelect) return;
    
    // Get available wildcard domains from select options
    const wildcardOptions = Array.from(tlsSelect.options).filter(opt => 
        opt.value.startsWith('wildcard:')
    );
    
    function detectWildcard() {
        const domains = domainsInput.value.split(/[,\s]+/).map(d => d.trim()).filter(d => d);
        if (domains.length === 0) return;
        
        const firstDomain = domains[0];
        
        // Find matching wildcard
        for (const opt of wildcardOptions) {
            const wildcardDomain = opt.value.replace('wildcard:', '');
            if (firstDomain.endsWith('.' + wildcardDomain)) {
                tlsSelect.value = opt.value;
                return;
            }
        }
        
        // No match - set to auto
        tlsSelect.value = 'auto';
    }
    
    // Only auto-detect for new sites (not editing)
    {{if .IsNew}}
    domainsInput.addEventListener('blur', detectWildcard);
    domainsInput.addEventListener('change', detectWildcard);
    {{end}}
});
</script>
