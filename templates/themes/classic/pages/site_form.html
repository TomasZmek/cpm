<div class="page-header">
    <div class="page-header-title">
        <h1>{{if .IsNew}}â• New Rule{{else}}âœï¸ Edit: {{.Site.PrimaryDomain}}{{end}}</h1>
    </div>
    <div class="page-header-actions">
        <a href="/sites" class="btn btn-secondary">â† Back</a>
    </div>
</div>

{{if .IsNew}}
<!-- Template Selector (only for new rules) -->
<div class="tabs" x-data="{ mode: 'scratch' }">
    <div class="tab-buttons">
        <button @click="mode = 'scratch'" :class="{ 'active': mode === 'scratch' }">
            ğŸ“ From Scratch
        </button>
        <button @click="mode = 'template'" :class="{ 'active': mode === 'template' }">
            ğŸ“‹ From Template
        </button>
    </div>
    
    <!-- Template Selection -->
    <div x-show="mode === 'template'" class="template-selector">
        <div class="form-group">
            <label>Category</label>
            <select x-model="selectedCategory" @change="selectedTemplate = null">
                <option value="">Select category...</option>
                {{range .Categories}}
                <option value="{{.ID}}">{{.Icon}} {{.Name}}</option>
                {{end}}
            </select>
        </div>
        
        <div class="templates-grid">
            {{range .Templates}}
            <div class="template-card" 
                 x-show="selectedCategory === '{{.Category}}'"
                 @click="selectTemplate('{{.ID}}')">
                <div class="template-icon">{{.Icon}}</div>
                <div class="template-name">{{.Name}}</div>
                <div class="template-desc">{{.Description}}</div>
            </div>
            {{end}}
        </div>
    </div>
</div>
{{end}}

<!-- Main Form -->
<form action="{{if .IsNew}}/sites{{else}}/sites/{{.Site.Filename}}{{end}}" 
      method="POST"
      hx-boost="true"
      class="site-form">
    
    {{if not .IsNew}}
    <input type="hidden" name="_method" value="PUT">
    {{end}}
    
    <div class="form-section">
        <h2>ğŸŒ Domain Configuration</h2>
        
        <div class="form-group">
            <label for="domains">Domains *</label>
            <input type="text" 
                   id="domains" 
                   name="domains" 
                   value="{{.Site.DomainsString}}"
                   placeholder="example.com, www.example.com"
                   required>
            <small class="form-help">Separate multiple domains with comma or space</small>
        </div>
    </div>
    
    <div class="form-section">
        <h2>ğŸ¯ Backend Target</h2>
        
        <div class="form-row">
            <div class="form-group flex-2">
                <label for="target_ip">IP Address *</label>
                <input type="text" 
                       id="target_ip" 
                       name="target_ip" 
                       value="{{if .Site.TargetIP}}{{.Site.TargetIP}}{{else}}{{.DefaultIP}}{{end}}"
                       placeholder="192.168.1.100"
                       required>
            </div>
            
            <div class="form-group flex-1">
                <label for="target_port">Port *</label>
                <input type="text" 
                       id="target_port" 
                       name="target_port" 
                       value="{{.Site.TargetPort}}"
                       placeholder="8080"
                       required>
            </div>
        </div>
        
        <div class="form-row">
            <label class="checkbox-label">
                <input type="checkbox" 
                       name="is_https_backend" 
                       {{if .Site.IsHTTPSBackend}}checked{{end}}>
                ğŸ”’ HTTPS Backend (skip certificate verification)
            </label>
        </div>
    </div>
    
    <div class="form-section">
        <h2>âš™ï¸ Snippets</h2>
        
        <div class="snippets-selector">
            {{range .AvailableSnippets}}
            <label class="checkbox-card">
                <input type="checkbox" 
                       name="snippets" 
                       value="{{.}}"
                       {{if contains $.Site.Snippets .}}checked{{end}}>
                <span class="checkbox-card-content">
                    {{if eq . "cloudflare_dns"}}â˜ï¸{{end}}
                    {{if eq . "internal_only"}}ğŸ”’{{end}}
                    {{if eq . "security_headers"}}ğŸ›¡ï¸{{end}}
                    {{if eq . "compression"}}ğŸ“¦{{end}}
                    {{if eq . "rate_limit"}}â±ï¸{{end}}
                    {{if eq . "basic_auth"}}ğŸ”{{end}}
                    {{.}}
                </span>
            </label>
            {{end}}
        </div>
    </div>
    
    <div class="form-section">
        <h2>ğŸ·ï¸ Tags</h2>
        
        <div class="form-group">
            <input type="text" 
                   id="tags" 
                   name="tags" 
                   value="{{join .Site.Tags ", "}}"
                   placeholder="production, web, api">
            <small class="form-help">Organize rules with comma-separated tags</small>
        </div>
    </div>
    
    <details class="form-section collapsible">
        <summary><h2>âš¡ Advanced Options</h2></summary>
        
        <div class="form-row">
            <label class="checkbox-label">
                <input type="checkbox" 
                       name="enable_websocket" 
                       {{if .Site.EnableWebSocket}}checked{{end}}>
                ğŸ”Œ Enable WebSocket Support
            </label>
            
            <label class="checkbox-label">
                <input type="checkbox" 
                       name="is_internal" 
                       {{if .Site.IsInternal}}checked{{end}}>
                ğŸ  Internal Only (LAN access)
            </label>
        </div>
        
        <div class="form-group">
            <label for="health_check_path">Health Check Path</label>
            <input type="text" 
                   id="health_check_path" 
                   name="health_check_path" 
                   value="{{.Site.HealthCheckPath}}"
                   placeholder="/health">
        </div>
        
        <div class="form-group">
            <label for="extra_config">Extra Caddy Configuration</label>
            <textarea id="extra_config" 
                      name="extra_config" 
                      rows="4"
                      placeholder="Additional Caddy directives...">{{.Site.ExtraConfig}}</textarea>
        </div>
    </details>
    
    <div class="form-actions">
        <a href="/sites" class="btn btn-secondary">Cancel</a>
        <button type="submit" class="btn btn-primary">
            {{if .IsNew}}Create Rule{{else}}Save Changes{{end}}
        </button>
    </div>
</form>
